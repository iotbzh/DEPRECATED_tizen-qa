/*
This script enhance the pages for entering "QAMETA" files.
*/
var metaction = (function(){
    var classes = { visi: 'ftc', hide: 'ftc-hide' };
    var metas = [];
    var done=false;
    var formtxt=null;
    var curform=null;
    var treatEvent = function(e){
	if (!done && (document.readyState=='interactive' || document.readyState=='complete')){
	    done = true;
	    document.removeEventListener('readystatechange',treatEvent,false);
	    init();
	}
    };
    document.addEventListener('readystatechange',treatEvent,false);
    var init = function() {
	var elts = document.body.getElementsByTagName('form');
	var i=0, n=elts.length;
	while(i<n) {
	    var e = elts.item(i++);
	    if(e.className==classes.visi)
		metas.push(e)
	}
	if (metas.length) {
	    var tag;
	    var divgrp = document.createElement("div");
	    var divtag = document.createElement("div");
	    var divfrm = document.createElement("div");
	    divgrp.appendChild(divtag);
	    divgrp.appendChild(divfrm);
	    e.parentNode.insertBefore(divgrp,metas[0])
	    divgrp.className='group';
	    divtag.className='tags';
	    divfrm.className='forms';
	    metas.forEach(function(e){
		    tag = document.createElement("div");
		    tag.setAttribute("onclick","javascript:metaction('"+e.id+"')");
		    tag.className='tag';
		    tag.appendChild(document.createTextNode(e.id+": "+e.name.value));
		    divtag.appendChild(tag);
		    divfrm.appendChild(e);
		    e.selbut = tag;
		});
	    // add +
	    tag = document.createElement("div");
	    tag.setAttribute("onclick","javascript:metaction('+');");
	    tag.className='tag';
	    tag.appendChild(document.createTextNode("+"));
	    divtag.appendChild(tag);
	    // hr -
	    tag = document.createElement("hr");
	    divtag.appendChild(tag);
	    // store
	    tag = document.createElement("div");
	    tag.setAttribute("onclick","javascript:metaction('@store');");
	    tag.className='paste';
	    tag.appendChild(document.createTextNode("store"));
	    divtag.appendChild(tag);
	    // paste
	    tag = document.createElement("div");
	    tag.setAttribute("onclick","javascript:metaction('@paste');");
	    tag.className='paste';
	    tag.appendChild(document.createTextNode("paste"));
	    divtag.appendChild(tag);

	    action((window.location.hash||'#0').substring(1));
	}
    };
    var testw = function(e) {
	return e.nodeType==1 && ('value' in e) && (
		    (e.tagName.toLowerCase()=='input' && e.type.toLowerCase()!='submit')
		|| (e.tagName.toLowerCase()=='textarea'));
    };
    var totxt = function(form) {
	function txt(e,a) { 
	    if(testw(e))
		a.push(e.value.split('\n').join('\\n')); 
	}
	function iter(e,a) { 
	    txt(e,a); 
	    var c=e.firstChild; 
	    while(c) { 
		iter(c,a); 
		c=c.nextSibling; 
	    } 
	    return a;
	}
	return iter(form,[]).join('\n');
    };
    var fromtxt = function(form,txt) {
	function set(e,a) { 
	    if(testw(e))
		e.value = a.shift().split('\\n').join('\n'); 
	}
	function iter(e,a) { 
	    set(e,a); 
	    var c=e.firstChild; 
	    while(c) { 
		iter(c,a); 
		c=c.nextSibling; 
	    } 
	}
	iter(form,txt.split('\n'));
    };
    var curkey = function() {
	var p = window.location.pathname;
	p = p.replace(/meta\/(.*)\/QAMETA.*json/,'$1');
	p = p.replace(/\/[0-9A-Z][0-9A-Z]-/g,'/');
	return p + '#' +curform.id+": "+curform.name.value;
    };
    var dialogpaste = function() {
	if(!window.localStorage) return;
	var n = window.localStorage.length;
	if(!n) return;
	var root = document.createElement("div");
	root.className='dialogpaste';
	var inner = document.createElement("div");
	inner.className='innerpaste';
	root.appendChild(inner);
	var tag = document.createElement("h1");
	tag.appendChild(document.createTextNode('Pasting a stored item'));
	inner.appendChild(tag);
	var close = function() {
	    document.body.removeChild(root);
	};
	tag = document.createElement("div");
	tag.addEventListener("click",close);
	tag.className='paste';
	tag.appendChild(document.createTextNode('cancel'));
	inner.appendChild(tag);
	var clear = function() {
	    while(window.localStorage.length)
		window.localStorage.removeItem(window.localStorage.key(0));
	    close();
	};
	tag = document.createElement("div");
	tag.addEventListener("click",clear);
	tag.className='paste';
	tag.appendChild(document.createTextNode('clear all'));
	inner.appendChild(tag);
	inner.appendChild(document.createElement("hr"));
	var set = function(txt) {
	    if (txt) fromtxt(curform,txt);
	    close();
	};
	var i = 0;
	while(i<n) {
	    (function(i){
		var key = window.localStorage.key(i);
		var value = window.localStorage.getItem(key);
		tag = document.createElement("div");
		tag.addEventListener("click",function(){set(value);});
		tag.className='paste';
		tag.appendChild(document.createTextNode('paste '+key));
		inner.appendChild(tag);
	    })(i++);
	}
	document.body.appendChild(root);
	return false;
    };
    var action = function(hash) {
	if (formtxt) {
	    var txt=totxt(curform);
	    if(hash=='@store' && window.localStorage) {
		var key = curkey();
		window.localStorage.setItem(key,txt);
		//alert('stored with key '+key);
		return;
	    }
	    if(hash=='@paste' && window.localStorage) {
		dialogpaste();
		return;
	    }
	    if (txt != formtxt && !confirm('TC changed!\nWant to drop ?'))
		return;
	    curform.reset();
	}
	if (hash=='+') {
	    var f=document.getElementById('newtc');
	    f && f.submit();
	}
	else {
	    metas.forEach(function(e){
		    if(e.id == hash) {
			e.className = classes.visi;
			e.selbut.className = 'tag focus';
			curform = e;
			formtxt = totxt(curform);
		    }
		    else {
			e.className = classes.hide;
			e.selbut.className = 'tag';
		    }
		});
	    window.location.hash='#'+hash;
	}
    };
    return action;
})();

