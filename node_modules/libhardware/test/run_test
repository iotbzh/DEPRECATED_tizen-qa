#!/usr/bin/env node

var util=require('util');
var _=require('underscore');

var HW=require('../index.js');

function dotest(label,func) {
	console.log("===== "+label+" =====");
	var rc=false;
	try {
		rc=func.call(null,Array.prototype.slice.call(arguments,2));
	}
	catch(e) {
		console.log("EXCEPTION caught: "+e);
		console.log(e.stack);
	}
	console.log("==> rc = "+rc+"\n");
}

var mgr;

dotest("Init manager",function() {
	mgr=new HW.Manager(__dirname);
	console.log(mgr);
	return true;
});
	
dotest("Add device 1",function() {
	return mgr.addDevice({
		id: "lenovoXX",
		product: "test",
		platform: "plat1",
		description: "desc1",
		hostname: "hostname1",
		mac_address: "11:22:33:44:55:66",
		ip_address: "192.168.10.250",
		comment: "some comments here"
	});
});

dotest("Get device 1",function() {
	var dev=mgr.getDeviceById("lenovoXX");
	console.log(dev);
	return (dev?true:false);
});

dotest("Add device 2",function() {
	return mgr.addDevice({
		id: "lenovoXX2",
		product: "test",
		platform: "plat2",
		description: "desc2",
		hostname: "hostname2",
		mac_address: "11:22:33:44:55:77",
		ip_address: "192.168.10.251",
		comment: "some comments here"
	});
});

var badhost={
	id: "lenovoXXbad",
	product: "test",
	platform: "plat",
	description: "desc",
	hostname: "hostnamebad",
	mac_address: "99:22:33:44:55:66",
	ip_address: "192.168.10.252",
	comment: "some comments here"
};

dotest("Add device (bad id)",function() {
	var dev=mgr.getDeviceById("lenovoXX");
	var host=_.clone(badhost);
	host.id=dev.id;
	return mgr.addDevice(host);
});

dotest("Add device (bad hostname)",function() {
	var dev=mgr.getDeviceById("lenovoXX");
	var host=_.clone(badhost);
	host.hostname=dev.hostname;
	return mgr.addDevice(host);
});

dotest("Add device (bad ip)",function() {
	var dev=mgr.getDeviceById("lenovoXX");
	var host=_.clone(badhost);
	host.ip_address=dev.ip_address;
	return mgr.addDevice(host);
});

dotest("Add device (bad mac)",function() {
	var dev=mgr.getDeviceById("lenovoXX");
	var host=_.clone(badhost);
	host.mac_address=dev.mac_address;
	return mgr.addDevice(host);
});

dotest("Remove devices",function() {
	return mgr.removeDevice("lenovoXX");
});

dotest("Remove device 2",function() {
	return mgr.removeDevice("lenovoXX2");
});

dotest("Manager state",function() {
	console.log(mgr);
	return true;
});

dotest("Save config",function() {
	return mgr.saveDevices();
});

